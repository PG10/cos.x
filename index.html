<script type="module">
import * as THREE from './js/three.module.js';
import { OrbitControls } from './js/addons/controls/OrbitControls.js';
import { GLTFLoader } from './js/addons/loaders/GLTFLoader.js';
import { DRACOLoader } from './js/addons/loaders/DRACOLoader.js';
import { RGBELoader } from './js/addons/loaders/RGBELoader.js';
import { EffectComposer } from './js/addons/EffectComposer.js';
import { RenderPass } from './js/addons/RenderPass.js';
import { UnrealBloomPass } from './js/addons/UnrealBloomPass.js';

// --- SCENE CONFIG ---
const CONFIG = {
    TONE_MAPPING_EXPOSURE: 1.2,
    BACKGROUND_COLOR: 0x111111,
    HDR_ENVIRONMENT_INTENSITY: 0.7,
    CERAMIC_COLOR: 0xe8e8e8,
    METAL_COLOR: 0x444444,
    LENS_EMISSIVE_COLOR: 0xfff2e0,
    SHADE_BASE_COLOR: 0xffffff,
    CERAMIC_ROUGHNESS: 0.9,
    SHADE_TRANSMISSION: 0.9,
    LENS_EMISSIVE_INTENSITY: 10.0,
    SHADE_EMISSIVE_INTENSITY: 0.05,
    BLOOM_STRENGTH: 1.2,
    BLOOM_RADIUS: 0.6,
    BLOOM_THRESHOLD: 0.8
};

// --- MODEL PATHS ---
const modelPaths = {
    'sink': './sink.glb',
    'shade': './shade.glb',
    'bands': './bands.glb',
    'feeds': './feeds.glb',
    'gripper': './gripper.glb',
    'holder': './holder.glb',
    'lens': './lens.glb',
    'suspension': './suspension.glb'
};

let scene, camera, renderer, controls, composer;
let lensObjects = [], shadeObjects = [];
let modelsLoaded = 0, totalModels = Object.keys(modelPaths).length;
let bloomPass;

// --- INIT FUNCTION ---
function init() {
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = CONFIG.TONE_MAPPING_EXPOSURE;
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(0, 1.5, 3);

    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.autoRotate = true;

    // HDR Environment
    new RGBELoader().setPath('./').load('env.hdr', (texture) => {
        texture.mapping = THREE.EquirectangularReflectionMapping;
        scene.environment = texture;
    });

    // Bloom composer
    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    bloomPass = new UnrealBloomPass(
        new THREE.Vector2(window.innerWidth, window.innerHeight),
        CONFIG.BLOOM_STRENGTH,
        CONFIG.BLOOM_RADIUS,
        CONFIG.BLOOM_THRESHOLD
    );
    composer.addPass(bloomPass);

    loadAllModels();
    setupUIControls();
    window.addEventListener('resize', onWindowResize, false);
    animate();
    document.getElementById('controls').style.display = 'block';
}

// --- LOAD MODELS ---
function loadAllModels() {
    const dracoLoader = new DRACOLoader();
    dracoLoader.setDecoderPath('./draco/');
    const loader = new GLTFLoader();
    loader.setDRACOLoader(dracoLoader);

    function loadPart(path, modelName, onMesh) {
        loader.load(path, (gltf) => {
            const obj = gltf.scene;
            obj.traverse((child) => { if (child.isMesh) onMesh(child); });
            scene.add(obj);
            modelsLoaded++;
            document.getElementById('loading').textContent = `Loading models... ${modelsLoaded}/${totalModels}`;
            if (modelsLoaded === totalModels) {
                document.getElementById('loading').style.display = 'none';
                const bulbLight = new THREE.PointLight(0xffd8b0, 50, 100);
                bulbLight.position.set(0, -0.5, 0);
                scene.add(bulbLight);
            }
        }, undefined, () => { modelsLoaded++; });
    }

    // Shade
    loadPart(modelPaths.shade, 'shade', mesh => {
        mesh.material = new THREE.MeshPhysicalMaterial({
            color: CONFIG.SHADE_BASE_COLOR,
            roughness: CONFIG.CERAMIC_ROUGHNESS,
            metalness: 0,
            transmission: CONFIG.SHADE_TRANSMISSION,
            thickness: 2,
            emissive: new THREE.Color(0xffd8b0),
            emissiveIntensity: CONFIG.SHADE_EMISSIVE_INTENSITY,
        });
        shadeObjects.push(mesh);
    });

    // Lens
    loadPart(modelPaths.lens, 'lens', mesh => {
        mesh.material = new THREE.MeshPhysicalMaterial({
            color: 0xffffff,
            roughness: 0.3,
            emissive: new THREE.Color(CONFIG.LENS_EMISSIVE_COLOR),
            emissiveIntensity: CONFIG.LENS_EMISSIVE_INTENSITY,
        });
        lensObjects.push(mesh);
    });

    // Holder
    loadPart(modelPaths.holder, 'holder', mesh => {
        mesh.material = new THREE.MeshStandardMaterial({
            color: CONFIG.CERAMIC_COLOR,
            roughness: CONFIG.CERAMIC_ROUGHNESS,
            metalness: 0.0,
        });
    });

    // Bands
    loadPart(modelPaths.bands, 'bands', mesh => {
        mesh.material = new THREE.MeshStandardMaterial({
            color: CONFIG.CERAMIC_COLOR,
            roughness: CONFIG.CERAMIC_ROUGHNESS,
            metalness: 0.1,
        });
    });

    // Feeds
    loadPart(modelPaths.feeds, 'feeds', mesh => {
        mesh.material = new THREE.MeshStandardMaterial({
            color: CONFIG.CERAMIC_COLOR,
            roughness: CONFIG.CERAMIC_ROUGHNESS,
            metalness: 0.0,
        });
    });

    // Gripper
    loadPart(modelPaths.gripper, 'gripper', mesh => {
        mesh.material = new THREE.MeshStandardMaterial({
            color: CONFIG.METAL_COLOR,
            roughness: 0.4,
            metalness: 1.0,
        });
    });

    // Suspension
    loadPart(modelPaths.suspension, 'suspension', mesh => {
        mesh.material = new THREE.MeshStandardMaterial({
            color: 0x222222,
            roughness: 0.7,
            metalness: 0.3,
        });
    });

    // Sink
    loadPart(modelPaths.sink, 'sink', mesh => {
        mesh.material = new THREE.MeshStandardMaterial({
            color: CONFIG.METAL_COLOR,
            roughness: 0.6,
            metalness: 0.8,
        });
    });
}

// --- UI CONTROLS ---
function setupUIControls() {
    const bloomSlider = document.getElementById('bloomStrength');
    const emissionSlider = document.getElementById('emissionIntensity');
    const exposureSlider = document.getElementById('exposure');

    bloomSlider.addEventListener('input', e => {
        CONFIG.BLOOM_STRENGTH = parseFloat(e.target.value);
        bloomPass.strength = CONFIG.BLOOM_STRENGTH;
    });

    emissionSlider.addEventListener('input', e => {
        let intensity = parseFloat(e.target.value);
        lensObjects.forEach(mesh => mesh.material.emissiveIntensity = intensity);
        shadeObjects.forEach(mesh => mesh.material.emissiveIntensity = intensity * 0.05);
    });

    exposureSlider.addEventListener('input', e => {
        renderer.toneMappingExposure = parseFloat(e.target.value);
    });
}

// --- WINDOW RESIZE ---
function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    composer.setSize(window.innerWidth, window.innerHeight);
}

// --- ANIMATION LOOP ---
let clock = new THREE.Clock();
function animate() {
    requestAnimationFrame(animate);
    let delta = clock.getElapsedTime();
    
    // Optional pulsing glow
    let pulse = 0.5 + Math.sin(delta * 2) * 0.5;
    lensObjects.forEach(mesh => mesh.material.emissiveIntensity = CONFIG.LENS_EMISSIVE_INTENSITY * pulse);
    shadeObjects.forEach(mesh => mesh.material.emissiveIntensity = CONFIG.SHADE_EMISSIVE_INTENSITY * pulse);

    if (controls) controls.update();
    if (composer) composer.render();
    else renderer.render(scene, camera);
}

// --- START ---
init();
</script>
