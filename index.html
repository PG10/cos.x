<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>LED Fixture Model - Local Three.js Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; overflow: hidden; background: #111; }
    canvas { display: block; }
    #loading {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 18px;
      z-index: 1000;
    }
    #controls {
      position: fixed;
      top: 20px; right: 20px;
      background: rgba(0,0,0,0.7);
      padding: 15px;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      z-index: 1000;
    }
    #controls label { display: block; margin: 5px 0; }
    #controls input[type="range"] { width: 150px; margin-left: 10px; }
  </style>
</head>
<body>
  <div id="loading">Loading LED Fixture...</div>
  <div id="controls" style="display: none;">
    <label>Bloom Strength: <input type="range" id="bloomStrength" min="0" max="10" step="0.1" value="1.2"></label>
    <label>Emission Power: <input type="range" id="emissionIntensity" min="0" max="50" step="1" value="10"></label>
    <label>Exposure: <input type="range" id="exposure" min="0" max="3" step="0.1" value="1.2"></label>
  </div>

  <script type="module">
    import * as THREE from './js/three.module.js';
    import { OrbitControls } from './js/addons/controls/OrbitControls.js';
    import { GLTFLoader } from './js/addons/loaders/GLTFLoader.js';
    import { DRACOLoader } from './js/addons/loaders/DRACOLoader.js';
    import { RGBELoader } from './js/addons/loaders/RGBELoader.js';
    import { EffectComposer } from './js/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from './js/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from './js/addons/postprocessing/UnrealBloomPass.js';

    // --- CONFIG ---
    const CONFIG = {
      TONE_MAPPING_EXPOSURE: 1.2,
      LENS_EMISSIVE_INTENSITY: 10.0,
      SHADE_EMISSIVE_INTENSITY: 0.05,
      BLOOM_STRENGTH: 1.2,
      BLOOM_RADIUS: 0.6,
      BLOOM_THRESHOLD: 0.8
    };

    let scene, camera, renderer, composer, controls;
    let lensObjects = [];

    init();

    function init() {
      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = CONFIG.TONE_MAPPING_EXPOSURE;
      renderer.outputEncoding = THREE.sRGBEncoding;
      document.body.appendChild(renderer.domElement);

      // Scene + Camera
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
      camera.position.set(0, 1.5, 3);

      // Controls
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Environment map
      const rgbeLoader = new RGBELoader();
      rgbeLoader.load('./textures/env.hdr', (texture) => {
        texture.mapping = THREE.EquirectangularReflectionMapping;
        scene.environment = texture;
      });

      // Postprocessing
      composer = new EffectComposer(renderer);
      composer.addPass(new RenderPass(scene, camera));
      const bloomPass = new UnrealBloomPass(
        new THREE.Vector2(window.innerWidth, window.innerHeight),
        CONFIG.BLOOM_STRENGTH,
        CONFIG.BLOOM_RADIUS,
        CONFIG.BLOOM_THRESHOLD
      );
      composer.addPass(bloomPass);

      // Draco + GLTF Loader
      const dracoLoader = new DRACOLoader();
      dracoLoader.setDecoderPath('./draco/');
      const loader = new GLTFLoader();
      loader.setDRACOLoader(dracoLoader);

      // Load example model (replace with yours)
      loader.load('./models/shade.glb', (gltf) => {
        const obj = gltf.scene;
        obj.traverse((child) => {
          if (child.isMesh) {
            child.material = new THREE.MeshPhysicalMaterial({
              color: 0xffffff,
              roughness: 0.9,
              transmission: 0.9,
              emissive: new THREE.Color(0xffd8b0),
              emissiveIntensity: CONFIG.SHADE_EMISSIVE_INTENSITY
            });
          }
        });
        scene.add(obj);
        document.getElementById('loading').style.display = 'none';
      });

      // Light
      const bulb = new THREE.PointLight(0xffd8b0, 50, 100);
      bulb.position.set(0, -0.5, 0);
      scene.add(bulb);

      // UI Controls
      document.getElementById('controls').style.display = 'block';
      setupUI(bloomPass);

      window.addEventListener('resize', onWindowResize);
      animate();
    }

    function setupUI(bloomPass) {
      document.getElementById('bloomStrength').addEventListener('input', e => {
        bloomPass.strength = parseFloat(e.target.value);
      });
      document.getElementById('emissionIntensity').addEventListener('input', e => {
        CONFIG.LENS_EMISSIVE_INTENSITY = parseFloat(e.target.value);
        lensObjects.forEach(lens => lens.material.emissiveIntensity = CONFIG.LENS_EMISSIVE_INTENSITY);
      });
      document.getElementById('exposure').addEventListener('input', e => {
        renderer.toneMappingExposure = parseFloat(e.target.value);
      });
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      composer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      composer.render();
    }
  </script>
</body>
</html>
